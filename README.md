# 植物生物量预测 - Vision Transformer 项目

## 项目概述
kaggle地址:https://www.kaggle.com/code/yunnahua/csiro-pred-vit
### 使用Vision Transformer模型预测植物图像的5个生物量指标（干苜蓿重量、干枯重量、鲜绿重量、总干重、GDM重量）。通过6次迭代优化，模型得分从0.20提升至0.48。

## 比赛概述
```
在本次竞赛中，你的任务是利用牧场图像预测放牧和饲料管理中五个关键生物质成分：
• 干燥的绿色植被（不含三叶草）
• 干燥的死物
• 干三叶草生物量
• 绿色干物质（GDM）
• 总干生物量
准确预测这些数量将帮助农民和研究人员监测牧场生长，优化饲料供应，并提升畜牧系统的可持续性。

计分
模型性能通过对所有（图像、目标）对的全局加权决定系数（R²）进行评估。
每行根据目标类型使用以下权重进行权重：
Dry_Green_g: 0.1
Dry_Dead_g: 0.1
Dry_Clover_g: 0.1
GDM_g: 0.2
Dry_Total_g: 0.5
这意味着，不是分别计算每个目标的R²再取平均，而是用所有行的行合并计算一个加权的R²，并应用上述每行权重。
```

## 📈 完整版本演进与优化历程

| 版本 | 加权R²得分 | 累计提升 | 关键改进 | 技术突破 | 实验周期 |
|------|-----------|----------|----------|----------|----------|
| **V1.0**<br>基础验证版 | **~0.20** | - | 基础ViT架构，随机初始化<br>简单数据增强<br>SGD优化器，MSE损失 | 验证ViT在生物量预测的可行性 | 50 epoch |
| **V2.0**<br>训练策略优化 | **~0.29** | **+45%** | 延长训练周期（200 epoch）<br>调整早停策略 | 发现充分训练时间的重要性 | 200 epoch |
| **V3.0**<br>迁移学习引入 | **~0.31** | **+55%** | 引入ImageNet预训练权重<br>5折交叉验证框架<br>AdamW优化器+权重衰减 | 迁移学习+交叉验证奠定基础 | 10 epoch |
| **V4.0**<br>评估框架完善 | **~0.35** | **+75%** | 定制加权R²评估指标<br>余弦退火学习率调度<br>科学化训练监控 | 建立数据驱动的优化循环 | 30 epoch |
| **V5.0**<br>生产级优化 | **0.36-0.46** | **+130%** | 丰富数据增强策略<br>测试时增强（TTA）<br>SmoothL1Loss损失函数<br>完整模型集成 | 集成最佳实践 | 100 epoch |
| **V6.0**<br>精细调优最终版 | **~0.48** | **+140%** | 微调学习率调度策略<br>（余弦退火周期epoch//2→epoch//4） | 精细化超参数调优 | 100 epoch |

### 1. 学习率调度演进
```python
# V4.0：标准余弦退火（周期=epoch）
scheduler = CosineAnnealingLR(optimizer, T_max=epoch)

# V5.0：缩短周期（周期=epoch//2）
scheduler = CosineAnnealingLR(optimizer, T_max=epoch//2)

# V6.0：最优周期（周期=epoch//4）→ 得分0.48
scheduler = CosineAnnealingLR(optimizer, T_max=epoch//4)
```

### 2. 数据增强的层次化演进
```
基础层（V1.0）：    几何变换（翻转）
中级层（V5.0）：   + 旋转90° + 颜色抖动
高级层（未来）：    + 随机擦除 + CutMix + 领域特定增强
```

### 3. 损失函数的科学选择
```
MSE（V1.0-V4.0）：   对异常值敏感，收敛快
↓
SmoothL1（V5.0-V6.0）：对异常值鲁棒，稳定收敛
```

### 4. 推理策略的工业级实现
```
基础推理（V1.0-V4.0）：   单次前向传播
↓
TTA推理（V5.0-V6.0）：    4种变换平均（原始+翻转+翻转+旋转）
↓
模型集成（V5.0-V6.0）：   5折模型结果平均
```

## 当前实现
- **模型**：Vision Transformer Base-16，ImageNet预训练
- **数据增强**：翻转、旋转、颜色抖动
- **训练策略**：5折交叉验证，AdamW优化器，SmoothL1损失
- **推理优化**：测试时增强（TTA），模型集成
- **评估指标**：加权R²（权重[0.1, 0.1, 0.1, 0.2, 0.5]）

## 注意事项
1. **提交格式**：不能读取`sample_submission.csv`文件，需要按照测试集的实际结构生成预测
2. **测试数据**：提交时存在隐藏测试项目，需考虑所有测试图片的所有目标值

## 后续优化计划
1. **图像分割**：添加分割分支，提取植物区域特征
2. **先进模型**：尝试DINOv2等自监督预训练模型
3. **增强策略**：探索更针对植物图像的数据增强方法
4. **误差分析**：深入分析预测误差模式，针对性改进

## 文件说明
- `submission.csv`：最终预测结果
- `VIT-CSIRO-[0-4].pth`：各折训练好的模型权重
- `submission-[0-4].csv`：各折独立预测结果

## 运行环境
- Python 3.8+
- PyTorch 1.12+
- CUDA 11.0+
- 依赖包：详见代码导入部分

---



